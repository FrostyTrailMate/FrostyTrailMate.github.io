# Set your Earth Explorer M2M code
m2m_code = "gpul8A@ScIhEe2DG!EGFgUUxKPnLREn@7@yCO6TFoo9!Z1FHnMu4OegGUEhaWpdx"

# Set your shapefile path
shapefile_path = "path/to/your/Shapefiles/Yosemite_Boundary.shp"

# Set your output directory
output_dir = "path/to/your/output_directory"
os.makedirs(output_dir, exist_ok=True)

# Set Earth Explorer API key
et.set_key(api_key=m2m_code)

# Download DEM data from Earth Explorer
print("Downloading DEM data...")
dem_path = et.data.get_data(
    product_id="AEAC29-5B68-4674-A3FB-E6E2D0A22EC0",
    destination_folder=output_dir,
    scene_id="LE07_L1TP_039030_20000907_20170126_01_T1",
)

# Read shapefile and clip the DEM to the bounding box
print("Reading shapefile and clipping DEM...")
boundary = gpd.read_file(shapefile_path)
clipped_dem, dem_extent = clip_raster(dem_path, boundary.geometry, nodata=-9999)

# Set the output contour shapefile path
#contour_shp_path = os.path.join(output_dir, "elevation_contours.shp")

# Generate 100-meter elevation contours from the clipped DEM
print("Generating contours...")
et.spatial.contour_from_raster(
    clipped_dem,
    output_path=contour_shp_path,
    interval=100,
    crs=dem_extent.spatialReference.ExportToWkt(),
)

# Connect to your PostgreSQL database
conn = psycopg2.connect(
    dbname="FTM8",
    user="postgres",
    password="admin",
    host="DESKTOP-UIUIA2A",
    port="5432"
)

# Create a cursor object
cur = conn.cursor()

# Create a table if it doesn't exist
cur.execute("""
    CREATE TABLE IF NOT EXISTS dem_p (
        id SERIAL PRIMARY KEY,
        vector GEOMETRY(LINESTRING, 4326)
    )
""")

# Insert contours into the database
for contour in contours:
    cur.execute("INSERT INTO dem_p (vector) VALUES (ST_GeomFromText(%s, 4326))", (contour.wkt,))

# Commit changes
conn.commit()

# Close cursor and connection
cur.close()
conn.close()

print("Contours saved to the database.")

# Print success message
# print(f"Contours saved to: {contour_shp_path}")
